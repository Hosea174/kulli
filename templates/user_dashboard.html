{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
  <div class="dashboard-controls">
      <div class="compact-trip-form">
    <form method="POST" action="{{ url_for('create_trip_route') }}">
      <div class="form-row">
        <input type="text" id="pickup_location" name="pickup_location" required 
               placeholder="Pickup address" autocomplete="street-address">
        <input type="text" id="destination" name="destination" required 
               placeholder="Destination address" autocomplete="street-address">
      </div>
      
      <div class="form-row">
        <input type="text" name="notes" placeholder="Additional notes (optional)">
        <input type="text" name="ecmr_link" placeholder="eCMR link (optional)">
      </div>
      
      <div class="truck-type-buttons">
        <button type="button" class="truck-btn" data-type="small_pickup">Small</button>
        <button type="button" class="truck-btn" data-type="mid_sized">Medium</button>
        <button type="button" class="truck-btn" data-type="large">Large</button>
        <input type="hidden" name="truck_type" id="truck_type" required>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn-primary">Create Trip</button>
        <a href="#" class="btn-secondary gps-link">Track GPS</a>
      </div>
    </form>
  </div>

  <h3>Your Trips</h3>
  <table class="trip-table">
    <thead>
      <tr>
        <th>Pickup</th>
        <th>Destination</th>
        <th>Distance</th>
        <th>Price</th>
        <th>Status</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for trip in trips %}
      <tr>
        <td>{{ trip.pickup_location }}</td>
        <td>{{ trip.destination }}</td>
        <td>{{ "%.2f"|format(trip.est_distance) }} km</td>
        <td>€{{ "%.2f"|format(trip.est_price) }}</td>
        <td>
          <span class="status-badge status-{{ trip.status }}">
            {{ trip.status|replace('_', ' ')|title }}
          </span>
        </td>
        <td>
          <button class="btn-secondary" onclick="showTripDetails('{{ trip.id }}')">
            View Details
          </button>
          {% if trip.status == 'waiting' %}
          {% if trip.status == 'waiting' %}
          <form method="POST" action="{{ url_for('update_trip_status_route') }}" class="trip-update-form">
            <input type="hidden" name="trip_id" value="{{ trip.id }}">
            <select name="status" class="status-select" onchange="this.form.submit()">
              <option value="waiting" selected>Waiting</option>
              <option value="canceled">Canceled</option>
            </select>
          </form>
          {% elif trip.status != 'waiting' %}
          <form method="POST" action="{{ url_for('update_trip_status_route') }}" class="trip-update-form">
            <input type="hidden" name="trip_id" value="{{ trip.id }}">
            <select name="status" class="status-select" onchange="this.form.submit()">
              <option value="{{ trip.status }}" selected>{{ trip.status|replace('_', ' ')|title }}</option>
              <option value="completed">Completed</option>
            </select>
          </form>
          {% endif %}
          {% elif trip.status != 'waiting' %}
          <form method="POST" action="{{ url_for('update_trip_status_route') }}" class="trip-update-form">
            <input type="hidden" name="trip_id" value="{{ trip.id }}">
            <select name="status" class="status-select" onchange="this.form.submit()">
              <option value="{{ trip.status }}" selected>{{ trip.status|replace('_', ' ')|title }}</option>
              <option value="completed">Completed</option>
            </select>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="trip-details-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Trip Details</h3>
      <div class="trip-details">
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="status-badge" id="trip-status"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Pickup:</span>
          <span id="trip-pickup"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Destination:</span>
          <span id="trip-destination"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Created:</span>
          <span id="trip-created"></span>
        </div>
        <h4>Estimated Details</h4>
        <div class="detail-row">
          <span class="detail-label">Distance:</span>
          <span id="trip-est-distance"></span> km
        </div>
        <div class="detail-row">
          <span class="detail-label">Duration:</span>
          <span id="trip-est-duration"></span> hours
        </div>
        <div class="detail-row">
          <span class="detail-label">Price:</span>
          €<span id="trip-est-price"></span>
        </div>
        <h4>Actual Details</h4>
        <div class="detail-row">
          <span class="detail-label">Distance:</span>
          <span id="trip-act-distance"></span> km
        </div>
        <div class="detail-row">
          <span class="detail-label">Duration:</span>
          <span id="trip-act-duration"></span> hours
        </div>
        <div class="detail-row">
          <span class="detail-label">Price:</span>
          €<span id="trip-act-price"></span>
          <button id="accept-price-btn" class="btn-secondary" style="display:none; margin-left:1rem">Accept Price</button>
          <button id="reject-price-btn" class="btn-secondary" style="display:none; margin-left:1rem">Request Adjustment</button>
        </div>
        
        <div class="status-controls" style="margin-top: 1rem;">
          <h4>Trip Status</h4>
          <select id="trip-status-select" class="status-select">
            <option value="waiting">Waiting</option>
            <option value="truck_assigned">Truck Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="canceled">Canceled</option>
          </select>
          <button id="update-status-btn" class="btn-secondary" style="margin-left:1rem">Update Status</button>
        </div>
        
        <h4>Cargo Details</h4>
        <div class="detail-row">
          <span class="detail-label">Description:</span>
          <span id="trip-cargo-description"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Weight:</span>
          <span id="trip-cargo-weight"></span> kg
        </div>
        <div class="detail-row">
          <span class="detail-label">Volume:</span>
          <span id="trip-cargo-volume"></span> m³
        </div>
        <div class="detail-row">
          <span class="detail-label">Special Requirements:</span>
          <span id="trip-special-requirements"></span>
        </div>
        
        <h4>Documents</h4>
        <div class="document-list" id="trip-documents"></div>
        
        <h4>Additional Information</h4>
        <div class="detail-row">
          <span class="detail-label">Notes:</span>
          <span id="trip-notes"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">eCMR Link:</span>
          <a id="trip-ecmr-link" target="_blank"></a>
        </div>
        <div class="detail-row">
          <span class="detail-label">GPS Tracking:</span>
          <a id="trip-gps-link" target="_blank"></a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Handle truck type selection
    document.querySelectorAll('.truck-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.truck-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('truck_type').value = btn.dataset.type;
      });
    });

    rejectBtn?.addEventListener('click', function() {
      const reason = prompt('Please specify what adjustments are needed:');
      if (reason) {
        fetch('/request-price-adjustment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            trip_id: tripId,
            reason: reason
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Adjustment request sent to truck owner');
            this.style.display = 'none';
          } else {
            alert('Error sending request: ' + (data.message || 'Unknown error'));
          }
        });
      }
    });

    // Handle status updates
    updateStatusBtn?.addEventListener('click', function() {
      const newStatus = statusSelect.value;
      
      fetch('/update-trip-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          trip_id: tripId,
          status: newStatus
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Status updated successfully');
          location.reload();
        } else {
          alert('Error updating status: ' + (data.message || 'Unknown error'));
        }
      });
    });

    // Get the modal
    const modal = document.getElementById('trip-details-modal');
    const modalContent = document.getElementById('trip-details-content');
    const span = document.getElementsByClassName('close')[0];

    function showTripDetails(tripId) {
      fetch(`/api/trip/${tripId}`)
        .then(response => response.json())
        .then(data => {
          // Update modal content with formatted data
          const statusElement = document.getElementById('trip-status');
          statusElement.textContent = data.status.replace('_', ' ').toUpperCase();
          statusElement.className = 'status-badge status-' + data.status;
          document.getElementById('trip-pickup').textContent = data.pickup_location;
          document.getElementById('trip-destination').textContent = data.destination;
          document.getElementById('trip-created').textContent = new Date(data.created_at).toLocaleString();
          
          // Estimated details
          document.getElementById('trip-est-distance').textContent = data.estimated.distance.toFixed(2);
          document.getElementById('trip-est-duration').textContent = (data.estimated.duration / 60).toFixed(1);
          document.getElementById('trip-est-price').textContent = data.estimated.price.toFixed(2);
          
          // Actual details
          document.getElementById('trip-act-distance').textContent = 
            data.actual.distance ? data.actual.distance.toFixed(2) : 'N/A';
          document.getElementById('trip-act-duration').textContent = 
            data.actual.duration ? (data.actual.duration / 60).toFixed(1) : 'N/A';
          document.getElementById('trip-act-price').textContent = 
            data.actual.price ? data.actual.price.toFixed(2) : 'N/A';
            
          // Additional fields
          document.getElementById('trip-notes').textContent = 
            data.notes ? data.notes : 'N/A';
            
          const ecmrLink = document.getElementById('trip-ecmr-link');
          if (data.ecmr_link) {
            ecmrLink.textContent = 'View eCMR';
            ecmrLink.href = data.ecmr_link;
            ecmrLink.style.display = 'inline';
          } else {
            ecmrLink.style.display = 'none';
          }
          
          const gpsLink = document.getElementById('trip-gps-link');
          if (data.gps_tracking_link) {
            gpsLink.textContent = 'Track GPS';
            gpsLink.href = data.gps_tracking_link;
            gpsLink.style.display = 'inline';
          } else {
            gpsLink.style.display = 'none';
          }

          // Show price controls based on status
          const acceptPriceBtn = document.getElementById('accept-price-btn');
          const rejectPriceBtn = document.getElementById('reject-price-btn');
          
          if (data.status === 'truck_assigned' && data.actual_price) {
            acceptPriceBtn.style.display = 'inline-block';
            rejectPriceBtn.style.display = 'inline-block';
          } else {
            acceptPriceBtn.style.display = 'none';
            rejectPriceBtn.style.display = 'none';
          }

          // Set status select value
          statusSelect.value = data.status;
          updateStatusBtn.style.display = data.status !== 'completed' && 
                                        data.status !== 'canceled' ? 'inline-block' : 'none';

          // Update cargo details
          document.getElementById('trip-cargo-description').textContent = 
            data.cargo_description || 'N/A';
          document.getElementById('trip-cargo-weight').textContent = 
            data.cargo_weight ? data.cargo_weight.toFixed(2) : 'N/A';
          document.getElementById('trip-cargo-volume').textContent = 
            data.cargo_volume ? data.cargo_volume.toFixed(2) : 'N/A';
          document.getElementById('trip-special-requirements').textContent = 
            data.special_requirements || 'N/A';

          // Update documents
          const documentsContainer = document.getElementById('trip-documents');
          documentsContainer.innerHTML = '';
          if (data.documents && data.documents.length > 0) {
            data.documents.forEach(doc => {
              const docLink = document.createElement('a');
              docLink.href = doc.url;
              docLink.textContent = doc.name || 'Document';
              docLink.target = '_blank';
              docLink.className = 'document-link';
              documentsContainer.appendChild(docLink);
              documentsContainer.appendChild(document.createElement('br'));
            });
          } else {
            documentsContainer.textContent = 'No documents available';
          }
            
          modal.style.display = 'block';
        });
    }

    span.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>


</div>

<script>
  // Function to fetch suggestions from the backend
  async function fetchSuggestions(query, inputField) {
    try {
      const url = '/api/autocomplete?query=' + encodeURIComponent(query);
      const response = await fetch(url);
      const data = await response.json();
      
      // Clear existing datalist
      const datalistId = 'suggestions-' + inputField.id;
      let existingDatalist = document.getElementById(datalistId);
      if (existingDatalist) {
        existingDatalist.remove();
      }

      // Create new datalist if we have suggestions
      if (data.features && data.features.length > 0) {
        const datalist = document.createElement('datalist');
        datalist.id = datalistId;

        data.features.forEach(feature => {
          const option = document.createElement('option');
          option.value = feature.place_name || feature.text || '';
          datalist.appendChild(option);
        });

        document.body.appendChild(datalist);
        inputField.setAttribute('list', datalistId);
      }
    } catch (error) {
      console.error('Error fetching autocomplete suggestions:', error);
    }
  }

  // Initialize autocomplete functionality
  function initAutocomplete() {
    const pickupInput = document.getElementById('pickup_location');
    const destinationInput = document.getElementById('destination');

    if (pickupInput && destinationInput) {
      // Debounce function to limit API calls
      const debounce = (func, delay) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      };

      const handleInput = debounce((input, field) => {
        if (input.length > 2) {
          fetchSuggestions(input, field);
        }
      }, 300);

      pickupInput.addEventListener('input', (e) => {
        handleInput(e.target.value, pickupInput);
      });

      destinationInput.addEventListener('input', (e) => {
        handleInput(e.target.value, destinationInput);
      });
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', initAutocomplete);
</script>


{% endblock %}
