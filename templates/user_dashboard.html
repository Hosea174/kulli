{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
  <h2>Welcome, {{ current_user.name }}</h2>
  <div class="dashboard-actions">
    <a href="/" class="btn-primary">Create a New Trip</a>
  </div>
  <h3>Your Trips</h3>
  <h3>Your Trips</h3>
  <table class="trip-table">
    <thead>
      <tr>
        <th>Pickup</th>
        <th>Destination</th>
        <th>Distance</th>
        <th>Price</th>
        <th>Status</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for trip in trips %}
      <tr>
        <td>{{ trip.pickup_location }}</td>
        <td>{{ trip.destination }}</td>
        <td>{{ "%.2f"|format(trip.est_distance) }} km</td>
        <td>€{{ "%.2f"|format(trip.est_price) }}</td>
        <td>
          <span class="status-badge status-{{ trip.status }}">
            {{ trip.status|replace('_', ' ')|title }}
          </span>
        </td>
        <td>
          <button class="btn-secondary" onclick="showTripDetails({{ trip.id }})">
            View Details
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="trip-details-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Trip Details</h3>
      <div class="trip-details">
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="status-badge status-{{ trip.status }}" id="trip-status"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Pickup:</span>
          <span id="trip-pickup"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Destination:</span>
          <span id="trip-destination"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Created:</span>
          <span id="trip-created"></span>
        </div>
        <h4>Estimated Details</h4>
        <div class="detail-row">
          <span class="detail-label">Distance:</span>
          <span id="trip-est-distance"></span> km
        </div>
        <div class="detail-row">
          <span class="detail-label">Duration:</span>
          <span id="trip-est-duration"></span> hours
        </div>
        <div class="detail-row">
          <span class="detail-label">Price:</span>
          €<span id="trip-est-price"></span>
        </div>
        <h4>Actual Details</h4>
        <div class="detail-row">
          <span class="detail-label">Distance:</span>
          <span id="trip-act-distance"></span> km
        </div>
        <div class="detail-row">
          <span class="detail-label">Duration:</span>
          <span id="trip-act-duration"></span> hours
        </div>
        <div class="detail-row">
          <span class="detail-label">Price:</span>
          €<span id="trip-act-price"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get the modal
    const modal = document.getElementById('trip-details-modal');
    const modalContent = document.getElementById('trip-details-content');
    const span = document.getElementsByClassName('close')[0];

    function showTripDetails(tripId) {
      fetch(`/api/trip/${tripId}`)
        .then(response => response.json())
        .then(data => {
          // Update modal content with formatted data
          document.getElementById('trip-status').textContent = data.status.replace('_', ' ').toUpperCase();
          document.getElementById('trip-status').className = `status-badge status-${data.status}`;
          document.getElementById('trip-pickup').textContent = data.pickup_location;
          document.getElementById('trip-destination').textContent = data.destination;
          document.getElementById('trip-created').textContent = new Date(data.created_at).toLocaleString();
          
          // Estimated details
          document.getElementById('trip-est-distance').textContent = data.estimated.distance.toFixed(2);
          document.getElementById('trip-est-duration').textContent = (data.estimated.duration / 60).toFixed(1);
          document.getElementById('trip-est-price').textContent = data.estimated.price.toFixed(2);
          
          // Actual details
          document.getElementById('trip-act-distance').textContent = 
            data.actual.distance ? data.actual.distance.toFixed(2) : 'N/A';
          document.getElementById('trip-act-duration').textContent = 
            data.actual.duration ? (data.actual.duration / 60).toFixed(1) : 'N/A';
          document.getElementById('trip-act-price').textContent = 
            data.actual.price ? data.actual.price.toFixed(2) : 'N/A';
            
          modal.style.display = 'block';
        });
    }

    span.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>

  <form method="POST" action="{{ url_for('create_trip_route') }}">
    <div class="form-group">
      <label for="pickup_location">Start Location:</label>
      <input type="text" id="pickup_location" name="pickup_location" required autocomplete="street-address">
    </div>

    <div class="form-group">
      <label for="destination">End Location:</label>
      <input type="text" id="destination" name="destination" required autocomplete="street-address">
    </div>

    <div class="form-group">
      <label>Truck Type:</label>
      <label>
        <input type="radio" name="truck_type" value="small_pickup" required> Small Pickup
      </label>
      <label>
        <input type="radio" name="truck_type" value="mid_sized" required> Mid-sized Truck
      </label>
      <label>
        <input type="radio" name="truck_type" value="large" required> Large Truck
      </label>
    </div>

    <button type="submit" class="btn-primary">Continue</button>
  </form>

</div>

<script>
  // Function to fetch suggestions from the backend
  async function fetchSuggestions(query, inputField) {
    try {
      const url = `/api/autocomplete?query=${encodeURIComponent(query)}`;
      const response = await fetch(url); // Asynchronous call to the backend
      const data = await response.json();
      console.log(data.features)
      // Clear existing datalist
      let datalistId = 'suggestions-' + inputField.id;
      let existingDatalist = document.getElementById(datalistId);
      if (existingDatalist) {
        existingDatalist.remove();
      }

      // Create a new datalist and populate it with suggestions
      const datalist = document.createElement('datalist');
      datalist.id = datalistId;

      if (data.features) {
        data.features.forEach(feature => {
          const option = document.createElement('option');
          option.value = feature.place_name; // Mapbox returns a "place_name" field
          datalist.appendChild(option);
        });
      }

      // Append the datalist to the document
      document.body.appendChild(datalist);

      // Associate the datalist with the input field
      inputField.setAttribute('list', datalistId);
    } catch (error) {
      console.error('Error fetching autocomplete suggestions:', error);
    }
  }

  // Add event listeners to the input fields for real-time autocomplete
  document.addEventListener('DOMContentLoaded', () => {
    const pickupInput = document.getElementById('pickup_location');
    const destinationInput = document.getElementById('destination');

    // Listen for the "input" event on both fields
    pickupInput.addEventListener('input', () => {
      const query = pickupInput.value;
      if (query.length > 2) { // Fetch suggestions only for queries longer than 2 characters
        fetchSuggestions(query, pickupInput);
      }
    });

    destinationInput.addEventListener('input', () => {
      const query = destinationInput.value;
      if (query.length > 2) {
        fetchSuggestions(query, destinationInput);
      }
    });
  });
</script>


{% endblock %}
