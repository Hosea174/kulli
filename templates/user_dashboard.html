{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
  <h2>Welcome, {{ current_user.name }}</h2>
  
  <div class="dashboard-sections">
    <!-- Trip Request Form -->
    <section class="trip-request">
      <h3>Create New Trip Request</h3>
      <form id="tripForm" class="trip-form">
        <div class="form-columns">
          <div class="form-column">
            <div class="form-group">
              <label for="pickup_location">Pickup Location:</label>
              <input type="text" id="pickup_location" name="pickup_location" required>
            </div>

            <div class="form-group">
              <label for="destination">Destination:</label>
              <input type="text" id="destination" name="destination" required>
            </div>

            <div class="form-group">
              <label for="est_distance">Estimated Distance (km):</label>
              <input type="number" id="est_distance" name="est_distance" 
                     step="0.01" min="0" max="10000" 
                     oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                     onblur="this.value = parseFloat(this.value).toFixed(2)">
            </div>

            <div class="form-group">
              <label for="est_duration">Estimated Duration (hours):</label>
              <input type="number" id="est_duration" name="est_duration" 
                     step="0.1" min="0" max="1000" 
                     oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                     onblur="this.value = parseFloat(this.value).toFixed(1)">
            </div>

            <div class="form-group">
              <label for="est_price">Maximum Price (€):</label>
              <input type="number" id="est_price" name="est_price" 
                     step="0.01" min="0" max="100000" 
                     oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                     onblur="this.value = parseFloat(this.value).toFixed(2)">
            </div>
          </div>

          <div class="form-column">
            <div class="form-group">
              <label for="cargo_description">Cargo Description:</label>
              <textarea id="cargo_description" name="cargo_description" required></textarea>
            </div>

            <div class="form-group">
              <label for="cargo_weight">Cargo Weight (kg):</label>
              <input type="number" step="0.1" id="cargo_weight" name="cargo_weight" required>
            </div>

            <div class="form-group">
              <label for="cargo_volume">Cargo Volume (m³):</label>
              <input type="number" step="0.1" id="cargo_volume" name="cargo_volume" required>
            </div>

            <div class="form-group">
              <label for="special_requirements">Special Requirements:</label>
              <textarea id="special_requirements" name="special_requirements"></textarea>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="estimateBtn" class="btn-secondary">Get Estimate</button>
          <button type="submit" id="submitBtn" class="btn-primary" disabled>Submit Trip Request</button>
        </div>
        
        <div id="estimateResults" style="display: none;">
          <h4>Route Estimates</h4>
          <div class="truck-type-buttons">
            <button type="button" class="truck-btn" data-truck-type="small_pickup">
              Small Pickup: <span class="price"></span>
            </button>
            <button type="button" class="truck-btn" data-truck-type="mid_sized">
              Mid-Sized: <span class="price"></span>
            </button>
            <button type="button" class="truck-btn" data-truck-type="large">
              Large: <span class="price"></span>
            </button>
          </div>
        </div>
      </form>
    </section>

    <!-- Trip Status Sections -->
    <section class="trip-status-section">
      <h3>Active Trips</h3>
      <div class="status-tabs">
        <button class="status-tab active" data-status="active">Active</button>
        <button class="status-tab" data-status="completed">Completed</button>
        <button class="status-tab" data-status="canceled">Canceled</button>
      </div>
    
      <div class="trip-tables">
        <!-- Active Trips Table -->
        <table class="trip-table active">
          <thead>
            <tr>
              <th>Pickup</th>
              <th>Destination</th>
              <th>Distance</th>
              <th>Max Price</th>
              <th>Bids</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for trip in trips.active_requests %}
            <tr class="trip-row" data-trip-id="{{ trip.id }}">
              <td>{{ trip.pickup_location }}</td>
              <td>{{ trip.destination }}</td>
              <td>{{ "%.2f"|format(trip.est_distance) }} km</td>
              <td>€{{ "%.2f"|format(trip.est_price) }}</td>
              <td>{{ trip.bid_count }}</td>
              <td>
                <span class="status-badge status-{{ trip.status }}">
                  {{ trip.status|replace('_', ' ')|title }}
                </span>
              </td>
              <td>
                <button class="btn-secondary toggle-details" data-trip-id="{{ trip.id }}">
                  View Bids
                </button>
              </td>
            </tr>
            <tr class="trip-details" id="details-{{ trip.id }}" style="display: none;">
              <td colspan="7">
                <div class="bid-list">
                  {% if trip.bids %}
                    <h4>Received Bids</h4>
                    <table class="bid-table">
                      <thead>
                        <tr>
                          <th>Truck Owner</th>
                          <th>Price</th>
                          <th>Details</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for bid in trip.bids %}
                        <tr>
                          <td>{{ bid.truck_owner.name }}</td>
                          <td>€{{ "%.2f"|format(bid.price) }}</td>
                          <td>
                            <button class="btn-secondary view-bid-details" data-bid-id="{{ bid.id }}">
                              View Details
                            </button>
                          </td>
                          <td>
                            <form method="POST" action="{{ url_for('accept_bid') }}">
                              <input type="hidden" name="bid_id" value="{{ bid.id }}">
                              <input type="hidden" name="trip_id" value="{{ trip.id }}">
                              <button type="submit" class="btn-primary">Accept Bid</button>
                            </form>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p>No bids received yet</p>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('tripForm');
    const pickupLocationInput = document.getElementById('pickup_location');
    const destinationInput = document.getElementById('destination');
    const distanceInput = document.getElementById('est_distance');
    const durationInput = document.getElementById('est_duration');
    const estimateBtn = document.getElementById('estimateBtn');
    const submitBtn = document.getElementById('submitBtn');
    const estimateResults = document.getElementById('estimateResults');
    const mapboxAccessToken = "{{ config.MAPBOX_ACCESS_TOKEN }}";

    function getRoute() {
        const pickup = pickupLocationInput.value;
        const destination = destinationInput.value;

        if (!pickup || !destination) {
            return;
        }

        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${pickup},${destination}?geometries=geojson&access_token=${mapboxAccessToken}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const distance = route.distance / 1000; // Convert meters to kilometers
                    const duration = route.duration / 3600; // Convert seconds to hours

                    distanceInput.value = distance.toFixed(2);
                    durationInput.value = duration.toFixed(2);
                } else if (data.message) {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
            });
    }

    estimateBtn.addEventListener('click', async function() {
        pickupLocationInput.addEventListener('blur', getRoute);
        destinationInput.addEventListener('blur', getRoute);

        if (!pickupLocationInput || !destinationInput) {
            console.error("Pickup or destination input not found");
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/estimate_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pickup_location: data.pickup_location,
                    destination: data.destination
                })
            });

            const result = await response.json();

            if (response.ok) {
                // Format numbers consistently
                const formattedDistance = parseFloat(result.distance.toFixed(2));
                const formattedDuration = parseFloat(result.duration.toFixed(2));
            
                distanceInput.value = formattedDistance;
                durationInput.value = formattedDuration;

                document.querySelectorAll('.truck-btn').forEach(btn => {
                    const type = btn.dataset.truckType;
                    const formattedPrice = parseFloat(result.price_estimates[type].toFixed(2));
                    btn.querySelector('.price').textContent = `€${formattedPrice}`;
                    btn.dataset.price = formattedPrice; // Store numeric value in data attribute
                });

                estimateResults.style.display = 'block';
                submitBtn.disabled = false;
            } else {
                throw new Error(result.error || 'Failed to get estimates');
            }
        } catch (error) {
            alert(error.message);
        }
    });

    document.querySelectorAll('.truck-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.truck-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            form.querySelector('input[name="est_price"]').value =
                parseFloat(this.querySelector('.price').textContent.replace('€', ''));
        });
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Safely get form elements with null checks
        const formElements = {
            pickupLocation: document.getElementById('pickup_location'),
            destination: document.getElementById('destination'),
            estDuration: document.getElementById('est_duration'),
            estDistance: document.getElementById('est_distance'),
            estPrice: document.getElementById('est_price'),
            cargoDescription: document.getElementById('cargo_description'),
            cargoWeight: document.getElementById('cargo_weight'),
            cargoVolume: document.getElementById('cargo_volume'),
            specialRequirements: document.getElementById('special_requirements')
        };

        // Check if any required element is missing
        for (const [key, element] of Object.entries(formElements)) {
            if (!element && key !== 'specialRequirements') {
                console.error(`Form element ${key} not found`);
                alert('Form submission error. Please refresh the page and try again.');
                return;
            }
        }

        // Validate required fields have values
        const requiredFields = [
            formElements.pickupLocation,
            formElements.destination,
            formElements.cargoDescription,
            formElements.cargoWeight,
            formElements.cargoVolume
        ];

        for (const field of requiredFields) {
            if (!field.value.trim()) {
                field.classList.add('error');
                alert('Please fill all required fields');
                return;
            }
            field.classList.remove('error');
        }

        // Validate numeric fields
        const numericFields = [
            {element: formElements.estDuration, min: 0, max: 1000},
            {element: formElements.estDistance, min: 0, max: 10000},
            {element: formElements.estPrice, min: 0, max: 100000},
            {element: formElements.cargoWeight, min: 0},
            {element: formElements.cargoVolume, min: 0}
        ];

        for (const field of numericFields) {
            const value = parseFloat(field.element.value);
            if (isNaN(value) || value < field.min || (field.max && value > field.max)) {
                field.element.classList.add('error');
                alert(`Invalid value for ${field.element.id}. Must be between ${field.min} and ${field.max || 'unlimited'}`);
                return;
            }
            field.element.classList.remove('error');
        }

        // Get selected truck type
        const selectedTruck = document.querySelector('.truck-btn.active');
        if (!selectedTruck) {
            alert('Please select a truck type');
            return;
        }
        const truckType = selectedTruck.dataset.truckType;

        // Prepare trip data with proper number formatting
        const tripData = {
            pickup_location: formElements.pickupLocation.value.trim(),
            destination: formElements.destination.value.trim(),
            est_duration: parseFloat(formElements.estDuration.value).toFixed(1),
            est_distance: parseFloat(formElements.estDistance.value).toFixed(2),
            est_price: parseFloat(formElements.estPrice.value).toFixed(2),
            truck_type: truckType,
            cargo_description: formElements.cargoDescription.value.trim(),
            cargo_weight: parseFloat(formElements.cargoWeight.value).toFixed(1),
            cargo_volume: parseFloat(formElements.cargoVolume.value).toFixed(1),
            special_requirements: formElements.specialRequirements ? formElements.specialRequirements.value.trim() : '',
            user_id: parseInt("{{ current_user.id }}")
        };

        // Convert string numbers back to numbers for API
        tripData.est_duration = parseFloat(tripData.est_duration);
        tripData.est_distance = parseFloat(tripData.est_distance);
        tripData.est_price = parseFloat(tripData.est_price);
        tripData.cargo_weight = parseFloat(tripData.cargo_weight);
        tripData.cargo_volume = parseFloat(tripData.cargo_volume);

        try {
            const response = await fetch('/create_trip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify(tripData)
            });

            const result = await response.json();

            if (response.ok) {
                window.location.href = '/user/dashboard';
            } else {
                throw new Error(result.error || 'Failed to create trip');
            }
        } catch (error) {
            alert(error.message);
        }
    });
});

document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('toggle-details')) {
        const tripId = e.target.dataset.tripId;
        const detailsRow = document.getElementById(`details-${tripId}`);

        if (detailsRow) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
        }
    }
});

document.querySelectorAll('.view-bid-details').forEach(button => {
    button.addEventListener('click', function() {
        const bidId = this.dataset.bidId;
        alert('Bid details for bid ID: ' + bidId);
    });
});
</script>
{% endblock %}
{% endblock %}
